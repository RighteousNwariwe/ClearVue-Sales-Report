<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Reports · ClearVue</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box} body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:#f6f7fb;margin:0}
    header{background:#32325d;color:#fff;padding:16px}
    nav{display:flex;gap:14px;align-items:center;background:#404060;color:#fff;padding:10px 16px}
    nav a{color:#fff;text-decoration:none;font-weight:600} .spacer{flex:1}
    .btn{border:0;background:#fff;color:#32325d;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .wrap{padding:18px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:10px;background:#e8e8f3;cursor:pointer;font-weight:700}
    .tab.active{background:#32325d;color:#fff}
    .panel{margin-top:12px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #eee;padding:8px;text-align:left}
  </style>
</head>
<body>
  <header><h2 style="margin:0">Reports</h2></header>
  <nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="reports.html">Reports</a>
    <a href="analytics.html">Analytics</a>
    <a href="admin.html">Admin</a>
    <span class="spacer"></span>
    <button class="btn" onclick="logout()">Logout</button>
  </nav>

  <div class="wrap">
    <div class="tabs">
      <div class="tab active" data-id="daily">Daily</div>
      <div class="tab" data-id="weekly">Weekly</div>
      <div class="tab" data-id="monthly">Monthly</div>
      <div class="tab" data-id="annual">Quarterly/Annual</div>
    </div>

    <div id="daily" class="panel">
      <h3>Daily Report</h3>
      <p>Sales by <b>customer</b>, <b>date</b>, <b>total</b>, and <b>items</b> from database.</p>
      <table>
        <thead><tr><th>Customer</th><th>Date</th><th>Total</th><th>Items</th></tr></thead>
        <tbody>
          <!-- Sales data will be loaded here -->
        </tbody>
      </table>
    </div>

    <div id="weekly" class="panel" style="display:none">
      <h3>Weekly Report</h3>
      <p>Top 10 / Bottom 10 products; trend vs last weeks.</p>
      <table>
        <thead><tr><th>Rank</th><th>Product</th><th>Weekly Sales</th><th>Trend</th></tr></thead>
        <tbody>
          <tr><td>1</td><td>LOR-100</td><td>R 210,000</td><td>+12%</td></tr>
          <tr><td>10</td><td>PR-555</td><td>R 35,000</td><td>-3%</td></tr>
        </tbody>
      </table>
    </div>

    <div id="monthly" class="panel" style="display:none">
      <h3>Monthly Report</h3>
      <p>Revenue, margins, acquisition/retention by product/category/brand; region & warehouse splits.</p>
      <table>
        <thead><tr><th>Category</th><th>Revenue</th><th>Margin</th><th>New Customers</th><th>Avg Order Size</th></tr></thead>
        <tbody>
          <tr><td>Electronics</td><td>R 2,400,000</td><td>31%</td><td>42</td><td>R 3,250</td></tr>
        </tbody>
      </table>
    </div>

    <div id="annual" class="panel" style="display:none">
      <h3>Quarterly / Annual Report</h3>
      <p>Seasonal patterns, quarterly comparisons, yearly performance.</p>
      <table>
        <thead><tr><th>Quarter</th><th>Revenue</th><th>YoY</th><th>Notes</th></tr></thead>
        <tbody>
          <tr><td>Q1</td><td>R 7,100,000</td><td>+9%</td><td>Promo lift</td></tr>
          <tr><td>Q2</td><td>R 6,850,000</td><td>+4%</td><td>Returns normalization</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // --- Auth
    function getUser(){ try{return JSON.parse(localStorage.getItem('currentUser')||'null')}catch{return null}}
    function requireAuth(){ const u=getUser(); if(!u){ location.href='index.html'; } return u; }
    function logout(){ localStorage.removeItem('currentUser'); location.href='index.html'; }
    requireAuth();

    // Tabs and dynamic data loading
    function showPanel(id) {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelector(`[data-id="${id}"]`).classList.add('active');
      document.querySelectorAll('.panel').forEach(p=>p.style.display='none');
      document.getElementById(id).style.display='block';
      // Load data for each tab
      if (id === 'daily') loadDailySales();
      if (id === 'weekly') loadWeeklyReport();
      if (id === 'monthly') loadMonthlyReport();
      if (id === 'annual') loadAnnualReport();
    }
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', (e)=>{
        showPanel(t.dataset.id);
      });
    });

    // --- Fetch sales data and populate Daily Report ---
    async function loadDailySales() {
      try {
        const res = await fetch('http://localhost:4000/api/sales');
        const sales = await res.json();
        const tbody = document.querySelector('#daily tbody');
        tbody.innerHTML = '';
        sales.forEach(sale => {
          const customer = sale.customerId?.name || 'N/A';
          const date = sale.saleDate ? new Date(sale.saleDate).toLocaleDateString() : 'N/A';
          const total = sale.total ? `R ${sale.total.toLocaleString()}` : 'N/A';
          const items = Array.isArray(sale.items)
            ? sale.items.map(item => `${item.quantity} × ${item.productId?.name || 'Product'}`).join(', ')
            : 'N/A';
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${customer}</td><td>${date}</td><td>${total}</td><td>${items}</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        // Show dummy data if API fails
        const tbody = document.querySelector('#daily tbody');
        tbody.innerHTML = `<tr><td>Demo Customer</td><td>2025-10-06</td><td>R 12,500</td><td>2 × Widget, 1 × Gadget</td></tr>`;
      }
    }

    // --- Weekly Report Dummy Data ---
    async function loadWeeklyReport() {
      const tbody = document.querySelector('#weekly tbody');
      tbody.innerHTML = '';
      try {
        const res = await fetch('http://localhost:4000/api/sales/weekly');
        const weekly = await res.json();
        weekly.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx + 1}</td><td>${row._id || 'Product'}</td><td>R ${row.totalSales?.toLocaleString() || '0'}</td><td>${row.totalUnits || 0} units</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td>1</td><td>Widget</td><td>R 21,000</td><td>+8%</td></tr>`;
      }
    }

    // --- Monthly Report Dummy Data ---
    async function loadMonthlyReport() {
      const tbody = document.querySelector('#monthly tbody');
      tbody.innerHTML = '';
      try {
        const res = await fetch('http://localhost:4000/api/sales/monthly');
        const monthly = await res.json();
        monthly.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row._id || 'Category'}</td><td>R ${row.revenue?.toLocaleString() || '0'}</td><td>-</td><td>-</td><td>-</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td>Electronics</td><td>R 240,000</td><td>29%</td><td>12</td><td>R 2,000</td></tr>`;
      }
    }

    // --- Annual Report Dummy Data ---
    async function loadAnnualReport() {
      const tbody = document.querySelector('#annual tbody');
      tbody.innerHTML = '';
      try {
        const res = await fetch('http://localhost:4000/api/sales/annual');
        const annual = await res.json();
        annual.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>Q${row._id}</td><td>R ${row.revenue?.toLocaleString() || '0'}</td><td>-</td><td>${row.count} sales</td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        tbody.innerHTML = `<tr><td>Q1</td><td>R 710,000</td><td>+9%</td><td>Promo lift</td></tr>`;
      }
    }

    // Load Daily tab by default
    showPanel('daily');
  </script>
</body>
</html>
